/**
 * Copyright 2026 Michał 'RazoRapiD' Knieć
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated
 * documentation files (the “Software”), to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software,
 * and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO
 * THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
 * THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * -------------------------------------------------------------------------------------------------------------------
 *
 * IMPORTANT: If you use this script or a modified version of it - you need to include this license and attribute the
 * copyright owner, as stated in the above license.
 */
import{downloadZip as s}from"./czip.js";const d={unknown:"unknown",unpatched:"unpatched",patched:"patched"},a=[[109,97,115,116,101,114,46,103,97,109,101,115,112,121,46,99,111,109,0],[109,97,115,116,101,114,46,120,45,110,117,108,108,46,110,101,116,0],[109,97,115,116,101,114,46,103,111,110,101,115,112,121,46,99,111,109,0],[109,97,115,116,101,114,46,103,97,109,101,116,105,114,46,99,111,109,0]],i=[109,97,115,116,101,114,46,103,97,109,101,116,105,114,46,99,111,109,0];let l=[],o=[],c,h;function u(){l=[]}function f(){o=[]}function p(t,e){if(c.classList.add("hidden"),h.classList.add("hidden"),0===e.length)t.innerHTML="";else{c.classList.remove("hidden"),t.innerHTML='<div class="md-typeset__scrollwrap"><div class="md-typeset__table"><table><thead><tr><th>Status</th><th>File</th><th>Masterserver</th><th>Size (bytes)</th><th>SHA-1 (Git)</th></tr></thead><tbody></tbody></table></div></div>';const a=t.querySelector("tbody");e.forEach(t=>{var e,n;e=a,t=t,(n=document.createElement("tr")).innerHTML=`<td class="st-${t.status}">${function(t){return t===d.unknown?"Unknown":t===d.unpatched?"Unpatched":t===d.patched?"Patched":void 0}(t.status)}</td><td>${t.name}</td><td>${function(t){t=new Set(t.filter(t=>0<t.text.length).map(t=>t.text));return[...t].map(t=>`<span>${t}</span>`).join("<br/>")}(t.content.masterservers)}</td><td>${t.size}</td><td>${t.hash}</td>`,e.appendChild(n)}),0<l.filter(t=>t.status===d.unpatched).length?h.classList.remove("hidden"):h.classList.add("hidden")}}function m(t,e){if(0===e.length)t.innerHTML="";else{c.classList.remove("hidden"),t.innerHTML='<div class="md-typeset__scrollwrap"><div class="md-typeset__table"><table><thead><tr><th>File</th><th>Size (bytes)</th><th>Download</th></tr></thead><tbody></tbody></table></div></div>';const a=t.querySelector("tbody");e.forEach(t=>{var e,n;e=a,t=t,(n=document.createElement("tr")).innerHTML=`<td>${t.name}</td><td>${t.blob.size}</td><td><a href="${t.url}" download="${t.name}">DOWNLOAD</a></td>`,e.appendChild(n)})}}function v(t,e){var n=new FileReader;n.onload=function(t){e(function(t){const e=new Uint8Array(t),n=[];return a.forEach(t=>{n.push(...function(t,e){var n=function(n){var a={};for(let t=0,e=n.length-1;t<e;++t)a[n[t]]=n.length-1-t;return a}(e);let a=[],r=0;for(;r<t.length;){var s=function(n,a,t,r){if(!(a.length<=0||t>=n.length)){t<0&&(t+=n.length,t=Math.max(0,t));for(let e=t;e<n.length;)for(let t=a.length-1;;--t){if(a[t]!==n[e+t]){var s=n[e+a.length-1],s=s in r?r[s]:a.length;e+=s;break}if(0===t)return e}}return-1}(t,e,r,n);if(-1===s)break;var d=function(e,n,a,r){let s="";for(let t=n;t<n+a-(r?1:0);t++)s+=String.fromCharCode(e[t]);return s}(t,s,e.length,!0);a.push({start:s,len:e.length,text:d}),r=s+e.length}return a}(e,t))}),{data:e,masterservers:[...n]}}(t.target.result))},n.readAsArrayBuffer(t)}function g(t){t=t.masterservers,t=new Set(t.filter(t=>0<t.text.length).map(t=>t.text));return 0===t.size?d.unknown:[...t].every(t=>"master.gametir.com"===t)?d.patched:d.unpatched}async function b(t){var e=t.length,e=(new TextEncoder).encode(`blob ${e}`),e=await new Blob([e.buffer,t.buffer],{type:"text/plain"}).arrayBuffer(),t=await crypto.subtle.digest("SHA-1",e);return t=new Uint8Array(t),Array.from(t).map(t=>t.toString(16).padStart(2,"0")).join("")}document.addEventListener("DOMContentLoaded",()=>{var t=document.getElementById("patcher");const e=t.querySelector(".file-area label");var n=t.querySelector('input[type="file"]');const a=t.querySelector(".file-entries"),r=t.querySelector(".result");c=t.querySelector("#clear"),h=t.querySelector("#patch"),c.addEventListener("click",t=>{t.preventDefault(),u(),p(a,l),f(),m(r,o)}),h.addEventListener("click",async t=>{t.preventDefault();var e,t=l.filter(t=>t.status===d.unpatched);0!==t.length&&(t=t.map(t=>{return t=t,e=i,{...t,content:{...t.content,data:function(e,s){return e.masterservers.forEach(t=>{var n=e.data,a=t,r=s;for(let t=a.start,e=0;t<a.start+r.length;t++,e++)n[t]=r[e]}),e.data}(t.content,e)}};var e}).map(t=>{return e=`(patched_${t.hash})_`+t.name,t=t.content.data,n="application/octet-stream",t=new Blob([t],{type:n}),a=URL.createObjectURL(t),{name:e,blob:t,url:a,type:n};var e,n,a}),e={name:"all_patched_binaries.zip",blob:e=await s(t.map(t=>({name:t.name,lastModified:new Date,input:t.blob}))).blob(),url:URL.createObjectURL(e),type:"application/zip"},o=[...t,e],u(),p(a,l),m(r,o))}),n.addEventListener("change",t=>{t=[...t.target.files];0!==t.length&&(f(),m(r,o),l=[],t.forEach(n=>{v(n,e=>{b(e.data).then(t=>{l.push({name:n.name,size:n.size,hash:t,content:e,status:g(e)}),p(a,l)})})}))}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("dragging"),f(),m(r,o),t.dataTransfer.items?[...t.dataTransfer.items].forEach((t,e)=>{if("file"===t.kind){const n=t.getAsFile();v(n,e=>{b(e.data).then(t=>{l.push({name:n.name,size:n.size,hash:t,content:e,status:g(e)}),p(a,l)})})}}):[...t.dataTransfer.files].forEach((n,t)=>{v(n,e=>{b(e.data).then(t=>{l.push({name:n.name,size:n.size,hash:t,content:e,status:g(e)}),p(a,l)})})})}),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragging")}),e.addEventListener("dragleave",t=>{e.classList.remove("dragging")})});
